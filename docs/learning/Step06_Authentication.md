# Step06: 認証・認可システム

## 🎯 この章の目標

JWT・API Key認証の実装詳細、RBAC（Role-Based Access Control）、セキュリティベストプラクティスを理解する

---

## 📋 概要

RAGシステムでは、企業の機密文書を扱うため、堅牢な認証・認可システムが不可欠です。JWT Token認証とAPI Key認証のハイブリッド方式により、Webアプリケーションと外部システム連携の両方に対応します。

### 🏗️ 認証システム構成

```text
認証・認可フロー
├── 認証方式
│   ├── JWT Token認証    # Webアプリケーション用
│   ├── API Key認証      # 外部システム連携用
│   └── フォールバック   # 複数方式の自動選択
├── 認可システム
│   ├── RBAC            # ロールベースアクセス制御
│   ├── リソース権限    # エンドポイント別権限
│   └── データフィルタ  # ユーザー別データ制限
└── セキュリティ機能
    ├── レート制限      # API制限・DoS対策
    ├── セッション管理  # トークン管理・無効化
    └── 監査ログ        # セキュリティイベント記録
```

---

## 🔐 JWT Token認証システム

### 1. JWT Token構造とクレーム

#### JWT Payload設計

**実装ファイル**: `../../app/core/jwt_claims.py`

JWTのペイロード構造は、標準クレームとカスタムクレームを組み合わせて設計されています。

**標準クレーム**:
- **sub (Subject)**: ユーザーの一意識別子（通常はメールアドレス）
- **iss (Issuer)**: トークンの発行者（rag-system）
- **aud (Audience)**: トークンの対象システム（rag-api）
- **exp (Expiration)**: 有効期限のUNIXタイムスタンプ
- **iat (Issued At)**: 発行時刻のUNIXタイムスタンプ
- **jti (JWT ID)**: トークンの一意識別子（ブラックリスト管理用）

**カスタムクレーム**:
- **user_id**: ユーザーのUUID
- **username**: ユーザー名
- **email**: メールアドレス
- **role**: ユーザーのロール（viewer/editor/admin/super_admin）
- **permissions**: 権限リスト（追加権限）
- **session_id**: セッションID（セッション管理用）

**メタデータ**:
- **login_method**: ログイン方式（password/oauth/api_key）
- **ip_address**: ログイン元IPアドレス
- **user_agent**: ユーザーエージェント情報

**設計のポイント**:
- 最小権限の原則に基づき、必要な情報のみを含む
- セッション管理とトークン管理の分離
- 監査ログに必要な情報の保持

### 2. JWT トークン管理サービス

**実装ファイル**: `../../app/services/jwt_service.py`

JWTトークンの生成、検証、管理を担当するサービスです。

**主要機能**:

1. **アクセストークン生成**:
   - 有効期限: デフォルト30分（設定変更可能）
   - ユーザー情報とリクエスト情報を含む
   - セッション情報をRedisに保存
   - 一意のJWT IDを生成（ブラックリスト管理用）

2. **リフレッシュトークン生成**:
   - 有効期限: デフォルト7日間
   - アクセストークンの更新専用
   - データベースに保存してセキュリティを強化
   - 使い捨て（ワンタイムトークン）として実装
    
3. **トークン検証**:
   - 署名の検証
   - 有効期限のチェック
   - セッション有効性の確認
   - ブラックリストのチェック
   - トークンタイプの確認（access/refresh）

4. **トークン無効化**:
   - JWT IDをブラックリストに追加
   - セッションの無効化
   - 有効期限まで保持して再利用を防止

5. **トークン更新**:
   - リフレッシュトークンの検証
   - 新しいアクセストークンの発行
   - 古いリフレッシュトークンの無効化
   - ユーザーステータスの再確認
    
**セキュリティ考慮事項**:
- HS256アルゴリズムを使用（対称鍵暗号）
- 秘密鍵は環境変数から取得
- トークンの有効期限を短く設定
- セッション情報とトークン情報の二重管理
- 異常なアクセスパターンの検出
    
**エラーハンドリング**:
- ExpiredSignatureError: トークン期限切れ
- InvalidTokenError: 無効なトークン形式
- セッション無効化エラー
- ユーザー非アクティブエラー

### 3. セッション管理

**実装ファイル**: `../../app/services/session_manager.py`

Redisベースのセッション管理システムで、JWTトークンと連携してセッション状態を管理します。

**主要機能**:

1. **セッション保存**:
   - Redisにセッション情報をJSON形式で保存
   - TTL（Time To Live）設定で自動削除
   - ユーザー別セッション一覧の管理
   - デフォルト7日間の有効期限

2. **セッション取得**:
   - セッションIDによる高速検索
   - JSONデシリアライズによるデータ復元
   - 存在しないセッションはNoneを返却

3. **セッション無効化**:
   - 特定セッションの削除
   - ユーザーの全セッション一括削除
   - ログアウト時の処理
   - パスワード変更時の既存セッション無効化

4. **トークンブラックリスト**:
   - 無効化されたJWT IDの管理
   - 有効期限まで保持（再利用防止）
   - 効率的な存在確認

**Redisキー設計**:
- `session:{session_id}`: セッションデータ
- `user_sessions:{user_id}`: ユーザーのセッション一覧
- `blacklist:{jti}`: ブラックリストトークン

**パフォーマンス最適化**:
- Redisの高速性を活用
- 適切なTTL設定によるメモリ管理
- パイプライン処理による効率化

---

## 🔑 API Key認証システム

### 1. API Key生成と管理

**実装ファイル**: `../../app/services/api_key_service.py`

API Key認証システムは、外部システム連携やバッチ処理に適した認証方式を提供します。

**API Key生成プロセス**:

1. **キー生成**:
   - 32文字のランダム文字列を生成（secrets.token_urlsafe使用）
   - プレフィックス付与（例: "rag_"）で識別性向上
   - 暗号学的に安全な乱数生成器を使用

2. **セキュアな保存**:
   - SHA-256ハッシュ化して保存（平文保存を回避）
   - プレフィックスのみ表示用に保持
   - データベースへの保存時にトランザクション使用

3. **メタデータ管理**:
   - キー名称と説明
   - 権限スコープ（permissions配列）
   - 有効期限（オプション）
   - レート制限設定
    
**API Key検証プロセス**:

1. **形式チェック**:
   - プレフィックスの確認
   - 長さの検証
   - 文字種の確認

2. **ハッシュ照合**:
   - 提供されたキーをSHA-256でハッシュ化
   - データベース内のハッシュと照合
   - タイミング攻撃への対策

3. **有効性確認**:
   - アクティブ状態のチェック
   - 有効期限の確認
   - ユーザーアカウントの状態確認

4. **使用統計更新**:
   - 使用回数のインクリメント
   - 最終使用日時の更新
   - 監査ログへの記録
    
**API Key管理機能**:

1. **一覧表示**:
   - ユーザーの全APIキー表示
   - 使用統計の確認
   - アクティブ/非アクティブの状態
   - 有効期限の確認

2. **無効化**:
   - 即座にキーを無効化
   - 所有者確認によるセキュリティ
   - 無効化の理由記録
   - 関連セッションのクリーンアップ

3. **ローテーション**:
   - 定期的なキー更新の推奨
   - 新キー生成と旧キー無効化
   - 移行期間の設定
   - 通知機能
    
**セキュリティベストプラクティス**:
- キーの平文保存を避ける
- 生成時のみ完全なキーを表示
- 定期的なローテーションの実施
- 使用されていないキーの自動無効化
- 異常なアクセスパターンの検出

### 2. レート制限システム

**実装ファイル**: `../../app/services/rate_limiter.py`

API使用量を制限し、システムの安定性とフェアな利用を保証するサービスです。

**レート制限アルゴリズム**:

**Sliding Window Log方式**:
- 正確なレート計算が可能
- RedisのSorted Setを使用
- タイムスタンプベースの管理
- 自動的な古いエントリの削除

**実装の特徴**:

1. **柔軟な制限設定**:
   - ユーザー別、APIキー別の制限
   - エンドポイント別の制限
   - グローバル制限の設定
   - カスタムウィンドウサイズ

2. **効率的な実装**:
   - Redisパイプラインによる最適化
   - アトミックな操作保証
   - TTL設定による自動クリーンアップ
   - メモリ効率的なデータ構造

3. **レスポンスヘッダー**:
   - X-RateLimit-Limit: 制限値
   - X-RateLimit-Remaining: 残り回数
   - X-RateLimit-Reset: リセット時刻
   - 429ステータスコードでの拒否

4. **バーストトラフィック対策**:
   - トークンバケット方式の併用
   - 短期間の大量リクエスト防止
   - 優先度ベースの制限

**設定例**:
- グローバル: 1000リクエスト/分
- 認証済みユーザー: 500リクエスト/分
- APIキー: 100リクエスト/分（デフォルト）
- 特定エンドポイント: カスタム設定

---

## 👤 RBAC (Role-Based Access Control)

### 1. ロール・権限定義

**実装ファイル**: `../../app/core/permissions.py`

Role-Based Access Control (RBAC) の実装で、柔軟な権限管理を実現します。

**権限カテゴリ**:

1. **ドキュメント権限**:
   - `document:read`: ドキュメント閲覧
   - `document:write`: ドキュメント作成・更新
   - `document:delete`: ドキュメント削除

2. **検索権限**:
   - `search:basic`: 基本検索機能
   - `search:advanced`: 高度な検索機能
   - `search:analytics`: 検索分析機能

3. **システム管理権限**:
   - `system:status`: システム状態確認
   - `system:metrics`: メトリクス閲覧
   - `system:config`: システム設定変更

4. **ユーザー管理権限**:
   - `user:read`: ユーザー情報閲覧
   - `user:write`: ユーザー作成・更新
   - `user:delete`: ユーザー削除

5. **APIキー管理権限**:
   - `apikey:read`: APIキー一覧閲覧
   - `apikey:write`: APIキー作成・更新
   - `apikey:delete`: APIキー削除

**システムロール**:

1. **viewer（閲覧者）**:
   - 基本的な読み取り権限のみ
   - ドキュメント閲覧と基本検索
   - 自身のAPIキー管理

2. **editor（編集者）**:
   - コンテンツの作成・編集権限
   - 高度な検索機能の利用
   - APIキーの作成・管理

3. **admin（管理者）**:
   - ほぼ全ての操作権限
   - ユーザー管理機能
   - システム監視機能

4. **super_admin（スーパー管理者）**:
   - 全権限を保有
   - システム設定の変更
   - 緊急時の対応権限

### 2. 権限チェック実装

**実装ファイル**: `../../app/services/authorization_service.py`

権限チェックを一元管理し、一貫性のあるアクセス制御を実現します。

**権限チェックの仕組み**:

1. **多層権限チェック**:
   - 個別付与された権限の確認
   - ロールベースの権限確認
   - リソースオーナーシップの確認
   - 管理者権限のバイパス

2. **FastAPI統合**:
   - 依存性注入による自動チェック
   - デコレーターパターンの活用
   - エンドポイントレベルでの宣言的権限指定
   - 403 Forbiddenの自動返却

3. **リソースベース権限**:
   - リソースタイプとアクションの組み合わせ
   - 所有者チェックの実装
   - 階層的な権限継承
   - 動的な権限判定

4. **使用パターン**:
   ```python
   # シンプルな権限チェック
   @Depends(require_permission("document:read"))
   
   # リソース所有者チェック付き
   @Depends(require_resource_permission("document", "write"))
   
   # 複数権限のOR条件
   @Depends(require_any_permission(["admin", "editor"]))
   
   # 複数権限のAND条件
   @Depends(require_all_permissions(["search:advanced", "document:read"]))
   ```

**セキュリティ考慮事項**:
- 最小権限の原則
- 明示的な権限付与
- デフォルト拒否
- 監査ログの記録

---

## 🛡️ セキュリティベストプラクティス

### 1. パスワードセキュリティ

**実装ファイル**: `../../app/services/password_service.py`

安全なパスワード管理のための包括的なサービスです。

**パスワード強度要件**:

1. **長さ要件**:
   - 最小8文字（設定可能）
   - 最大128文字
   - エントロピー計算による強度評価

2. **複雑性要件**:
   - 小文字を含む
   - 大文字を含む
   - 数字を含む
   - 特殊文字を含む

3. **追加チェック**:
   - 一般的なパスワードの拒否
   - ユーザー名との類似性チェック
   - 過去のパスワードとの重複チェック
   - 辞書攻撃への耐性

**ハッシュ化戦略**:

1. **bcryptアルゴリズム**:
   - salt rounds: 12（調整可能）
   - 自動的なソルト生成
   - タイミング攻撃への耐性

2. **パスワード履歴**:
   - 過去5回分のハッシュを保存
   - 再利用防止チェック
   - 定期的な変更促進

3. **安全なパスワード生成**:
   - 暗号学的に安全な乱数生成
   - 各文字種を確実に含む
   - 十分なエントロピーの確保

**パスワードポリシー**:
- 90日ごとの変更推奨
- 連続ログイン失敗でのロック
- パスワードリセットトークンの有効期限
- 多要素認証の推奨

### 2. セキュリティミドルウェア

**実装ファイル**: `../../app/core/security_middleware.py`

すべてのHTTPリクエスト/レスポンスに対してセキュリティ処理を適用します。

**セキュリティヘッダー**:

1. **HSTS (HTTP Strict Transport Security)**:
   - HTTPS接続の強制
   - 中間者攻撃の防止
   - サブドメインへの適用

2. **XSS対策**:
   - X-Content-Type-Options: MIMEタイプスニッフィング防止
   - X-Frame-Options: クリックジャッキング防止
   - X-XSS-Protection: XSSフィルタの有効化

3. **CSP (Content Security Policy)**:
   - スクリプト実行の制限
   - 外部リソースの読み込み制限
   - インラインスクリプトの制御

4. **その他のセキュリティ対策**:
   - Referrer-Policy: リファラ情報の制限
   - Permissions-Policy: ブラウザ機能の制限
   - CORS設定: クロスオリジン制御

**レート制限の統合**:
- IPアドレスベースの制限
- 認証状態による制限調整
- DDoS攻撃の緩和
- 適切なエラーレスポンス

**監視機能**:
- リクエスト処理時間の記録
- 異常なアクセスパターンの検出
- セキュリティイベントのログ記録
- メトリクスの収集

---

## ❗ よくある落とし穴と対策

### 1. JWT セキュリティ問題

**対策実装**: `../../app/core/jwt_key_manager.py`

**問題点**:
- 固定の秘密鍵使用
- 短い鍵長での運用
- 鍵のローテーション未対応
- ソースコードへの鍵埋め込み

**ベストプラクティス**:

1. **秘密鍵管理**:
   - 環境変数からの取得
   - 最小32文字の鍵長要求
   - AWS Secrets Manager等の利用
   - 開発/本番環境の分離

2. **鍵ローテーション**:
   - 定期的な鍵の更新
   - 移行期間の設定
   - 複数鍵での検証対応
   - 自動ローテーション機能

### 2. API Key 漏洩対策

**対策実装**: `../../app/services/api_key_security.py`

**セキュリティリスク**:
- 平文でのデータベース保存
- ログファイルへの出力
- バックアップでの露出
- 不適切な権限管理

**保護対策**:

1. **ハッシュ化保存**:
   - SHA-256による不可逆変換
   - タイミング攻撃対策
   - プレフィックスのみ表示
   - 完全なキーは生成時のみ

2. **自動ローテーション**:
   - 有効期限の設定
   - 定期的な更新促進
   - 古いキーの自動無効化
   - 使用統計による判断

### 3. 権限昇格脆弱性

**対策実装**: `../../app/services/role_management_service.py`

**脆弱性のパターン**:
- 権限チェックの欠如
- 自己権限昇格の許可
- ロール階層の無視
- 間接的な権限昇格

**防御策**:

1. **厳密な権限チェック**:
   - 管理者権限の必須化
   - ロール階層の実装
   - 自己変更の禁止
   - 監査ログの記録

2. **ロール階層管理**:
   - 明確な権限レベル定義
   - 上位権限への昇格防止
   - 最小権限の原則
   - 職務分離の実施

3. **追加の保護**:
   - 二要素認証の要求
   - 承認ワークフロー
   - 時限的な権限付与
   - 定期的な権限レビュー

---

## 🎯 理解確認のための設問

### JWT理解

1. JWTクレームで`sub`、`iss`、`aud`各フィールドの役割を説明してください
2. アクセストークンとリフレッシュトークンを分ける理由とその利点を説明してください
3. JWT黒リスト機能が必要な理由と実装上の考慮点を説明してください

### API Key理解

1. API Keyをハッシュ化して保存する理由と、プレフィックス表示の目的を説明してください
2. レート制限でSliding Window Logアルゴリズムを使用する利点を説明してください
3. API Key権限とユーザー権限の違いと使い分けを説明してください

### RBAC理解

1. ロールベースアクセス制御の利点と、権限の粒度設計について説明してください
2. リソースオーナーシップチェックが必要な場面と実装方法を説明してください
3. 権限昇格脆弱性を防ぐための3つの対策を挙げてください

### セキュリティ理解

1. セキュリティミドルウェアで設定される5つのHTTPヘッダーの目的を説明してください
2. パスワード強度チェックで検証すべき6つの要素を挙げてください
3. 秘密鍵ローテーションが必要な理由と実装時の注意点を説明してください

---

## 📚 次のステップ

認証・認可システムを理解できたら、次の学習段階に進んでください：

- **Step07**: エラーハンドリングと監視 - 例外処理・ログ・メトリクス収集
- **Step08**: デプロイメントと運用 - Docker・Kubernetes・CI/CD・監視

堅牢な認証・認可システムは、企業システムの信頼性を決定する重要な要素です。次のステップでは、システムの安定性を支えるエラーハンドリングと監視について学習します。
